<!DOCTYPE html>
<html lang="zh" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è´¢åŠ¡æ•°æ®ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        /* === 1. å¸ƒå±€åŸºç¡€ === */
        html, body { 
            height: 100%; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa !important; 
        }
        .main-wrapper { height: 100%; display: flex; flex-direction: column; }
        
        /* === 2. é¡¶éƒ¨å·¥å…·æ  === */
        .toolbar-section {
            flex-shrink: 0; 
            padding: 12px 24px; 
            background-color: #ffffff;
            border-bottom: 1px solid #e1e4e8; 
            z-index: 2000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
        }

        /* === 3. è¡¨æ ¼å®¹å™¨ === */
        .table-container {
            flex-grow: 1; 
            overflow: auto; 
            padding: 0; 
            position: relative;
            background: #fff;
        }
        .table { margin-bottom: 0; }

        /* === 4. è¡¨å¤´ç¾åŒ– === */
        thead th { 
            position: sticky; 
            top: 0; 
            z-index: 1000; /* æ™®é€šè¡¨å¤´å±‚çº§ */
            background-color: #f8f9fa !important; 
            border-bottom: 2px solid #e9ecef !important;
            border-top: none !important;
            border-left: none !important;
            border-right: none !important; 
            padding: 8px 0; 
            height: auto;
            vertical-align: middle; 
            background-clip: padding-box;
            box-shadow: 0 1px 0 #e9ecef;
            min-width: 100px; 
        }
        
        /* === 5. å†»ç»“åˆ—æ ¸å¿ƒæ ·å¼ (ä¿®å¤é‡å é€æ˜é—®é¢˜) === */
        
        /* åŸºç¡€å†»ç»“åˆ—å±æ€§ */
        .sticky-col {
            position: sticky !important;
            z-index: 101; /* å¿…é¡»é«˜äºæ™®é€štd(auto) */
            border-bottom: 1px solid #f1f3f5;
        }

        /* [æ ¸å¿ƒä¿®å¤] å¼ºåˆ¶ç»™æ•°æ®è¡Œçš„å†»ç»“åˆ—è®¾ç½®çº¯ç™½èƒŒæ™¯ï¼Œé˜²æ­¢é€è§† */
        tbody td.sticky-col {
            background-color: #fff !important; 
        }

        /* è¡¨å¤´äº¤å‰ç‚¹ (å·¦ä¸Šè§’ä¸¤æ ¼) */
        thead th.sticky-col {
            z-index: 1002 !important; /* æœ€é«˜å±‚çº§ */
            background-color: #f8f9fa !important; /* ä¿æŒè¡¨å¤´åº•è‰² */
        }

        /* [æ ¸å¿ƒä¿®å¤] é¼ æ ‡æ‚¬åœè¡Œæ—¶ï¼Œå†»ç»“åˆ—èƒŒæ™¯è‰²ä¹Ÿè¦åŒæ­¥å˜è‰² (æµ…è“) */
        /* å¦‚æœä¸åŠ è¿™è¡Œï¼Œæ‚¬åœæ—¶å†»ç»“åˆ—ä¼šä¿æŒç™½è‰²ï¼Œå¾ˆéš¾çœ‹ */
        .clickable-row:hover .sticky-col {
            background-color: #f1f8ff !important;
        }

        /* ç¬¬ä¸€åˆ—ï¼šä»£ç  (é å·¦ 0px) */
        .col-code {
            left: 0;
            width: 90px;
            min-width: 90px;
            max-width: 90px;
            border-right: 1px solid #f1f3f5;
        }

        /* ç¬¬äºŒåˆ—ï¼šåç§° (é å·¦ 90px) */
        .col-name {
            left: 90px; /* ç´§è´´ç¬¬ä¸€åˆ— */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            /* å³ä¾§åŠ æ·±ä¸€ç‚¹è¾¹æ¡†ï¼Œå¹¶åœ¨å³ä¾§åŠ é˜´å½±å®ç°â€œæµ®èµ·â€æ„Ÿ */
            border-right: 1px solid #e1e4e8 !important; 
            box-shadow: 4px 0 8px -4px rgba(0,0,0,0.1); 
        }

        /* === 6. è¡¨å¤´å†…å®¹ç¾åŒ– === */
        .th-content {
            padding: 0 12px;
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            width: 100%; 
            min-height: 32px;
            cursor: pointer; 
            position: relative;
            color: #495057; 
            font-weight: 600; 
            font-size: 13px;  
            transition: background-color 0.2s;
        }

        /* æ¢è¡Œæ§åˆ¶ */
        .th-content > span:first-child {
            display: inline-block;
            white-space: normal;      
            min-width: 5em;           
            max-width: 9.5em;         
            line-height: 1.35;        
            text-align: left;
        }
        
        .th-content:hover { 
            background-color: #eef1f6; 
            color: #0d6efd; 
        }

        /* === 7. å›¾æ ‡ä¸äº¤äº’ === */
        .sort-icon { 
            font-size: 10px; color: #adb5bd; margin-left: 4px; 
            opacity: 0.5; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;      
        }
        .th-content:hover .sort-icon { opacity: 1; color: #0d6efd; }
        
        .info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 14px; height: 14px; 
            border-radius: 50%; 
            background-color: rgba(173, 181, 189, 0.3); 
            color: #6c757d; font-size: 10px; margin-left: 4px; 
            cursor: help; transition: all 0.2s; flex-shrink: 0; 
        }
        .info-icon:hover { background-color: #0d6efd; color: white; }

        .filter-active .th-content { 
            background-color: #e8f2ff; color: #0d6efd; border-bottom: 2px solid #0d6efd; 
        }
        .filter-active .sort-icon { color: #0d6efd; opacity: 1; }

        .filter-popup {
            display: none; position: absolute; top: 100%; left: 0;
            min-width: 220px; background: white;
            border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 8px 24px rgba(0,0,0,0.12); 
            border-radius: 6px; padding: 16px; z-index: 1050; cursor: default; font-size: 13px;
        }
        thead th:hover .filter-popup, .filter-popup:hover { display: block; }
        thead th:last-child .filter-popup { left: auto; right: 0; }

        .filter-input-group { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .filter-input { 
            width: 80px; font-size: 13px; padding: 6px; 
            border-color: #dee2e6; background: #f8f9fa;
        }
        .filter-input:focus { background: #fff; border-color: #86b7fe; box-shadow: none; }
        .filter-label { font-size: 12px; color: #868e96; margin-bottom: 6px; display: block; font-weight: 500;}

        .table-nowrap td { 
            white-space: nowrap; vertical-align: middle; 
            padding: 10px 16px; font-size: 13px; color: #212529;
            border-bottom: 1px solid #f1f3f5; 
        }
        .clickable-row { cursor: pointer; transition: background-color 0.1s; }
        .clickable-row:hover { background-color: #f1f8ff !important; } 
        
        .fw-bold { font-weight: 600 !important; color: #343a40; }
        
        #chart-container { height: 500px; width: 100%; }
        .tooltip { z-index: 10000 !important; }
    </style>
</head>
<body class="bg-light">

<div class="main-wrapper">
    <div class="toolbar-section">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h2 class="h6 mb-0 fw-bold text-dark d-flex align-items-center">
                    <span style="font-size: 1.2rem; margin-right: 8px;">ğŸ“Š</span> æ¸¯è‚¡å…¨ç»´è´¢åŠ¡ç›‘æ§
                </h2>
                <span class="badge bg-light text-secondary border ms-3 fw-normal">
                    å…± <strong id="visibleCount" class="text-dark">{{ stocks|length }}</strong> / {{ stocks|length }}
                </span>
                <span class="badge bg-light text-secondary border ms-2 fw-normal">
                    ğŸ•’ <span id="updateTime">{{ last_updated }}</span>
                </span>
            </div>
            
            <div class="d-flex align-items-center">
                <div id="progress-container" class="me-3" style="display:none;">
                    <div class="progress" style="height: 6px; width: 120px;">
                        <div id="progress-bar" class="progress-bar bg-success" style="width: 0%"></div>
                    </div>
                    <div class="text-center" style="font-size: 10px; color: #999; margin-top: 2px;" id="progress-msg"></div>
                </div>
                
                <div class="btn-group">
                    <button id="refreshBtn" onclick="triggerCrawl()" class="btn btn-outline-secondary btn-sm">âš¡ åˆ·æ–°</button>
                    <button id="recalcBtn" onclick="triggerRecalculate()" class="btn btn-outline-secondary btn-sm">ğŸ› ï¸ è¡¥å…¨</button>
                    <button id="restartBtn" onclick="restartService()" class="btn btn-outline-danger btn-sm">ğŸ”¥ é‡å¯</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-hover mb-0 table-nowrap" id="stockTable">
            <thead>
                <tr>
                    <th class="sticky-col col-code">
                        <div class="th-content" onclick="sortTable('code', 'string')"><span>ä»£ç </span> <span class="sort-icon"></span></div>
                    </th>
                    <th class="sticky-col col-name">
                        <div class="th-content" onclick="sortTable('name', 'string')"><span>åç§°</span> <span class="sort-icon"></span></div>
                    </th>
                    <th style="min-width: 100px;">
                        <div class="th-content" onclick="sortTable('date', 'string')"><span>æ—¥æœŸ</span> <span class="sort-icon"></span></div>
                    </th>

                    {% for col in columns %}
                    <th data-key="{{ col.key }}">
                        <div class="th-content" onclick="sortTable('{{ col.key }}', 'numeric')">
                            <span class="d-flex align-items-center">
                                {{ col.label }}
                                {% if col.tip %}
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="<b>{{ col.desc }}</b><br><small>{{ col.tip }}</small>"
                                      onclick="event.stopPropagation()">?</span>
                                {% endif %}
                            </span>
                            <span class="sort-icon"></span>
                        </div>
                        <div class="filter-popup" onclick="event.stopPropagation()">
                            <span class="filter-label">ç­›é€‰ {{ col.label }}:</span>
                            <div class="filter-input-group">
                                <input type="number" class="form-control form-control-sm filter-input" placeholder="Min" id="min-{{ col.key }}">
                                <span class="text-muted">-</span>
                                <input type="number" class="form-control form-control-sm filter-input" placeholder="Max" id="max-{{ col.key }}">
                            </div>
                            <div class="d-flex justify-content-between pt-2 border-top">
                                <button class="btn btn-light btn-sm px-3" style="font-size: 12px;" onclick="clearFilter(this, '{{ col.key }}')">æ¸…é™¤</button>
                                <button class="btn btn-primary btn-sm px-3" style="font-size: 12px;" onclick="confirmFilter(this, '{{ col.key }}')">ç¡®è®¤</button>
                            </div>
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartTitle">å†å²è¶‹åŠ¿åˆ†æ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"><div id="chart-container"></div></div>
        </div>
    </div>
</div>

<script>
    const g_stockData = {{ stocks | tojson | safe }};
    const g_columns = {{ columns | tojson | safe }};
    let g_visibleStocks = [...g_stockData]; 
    
    document.addEventListener("DOMContentLoaded", function(){
        renderTable(g_stockData);
        [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function (el) { return new bootstrap.Tooltip(el, {html: true}); });
    });

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100" class="text-center py-4 text-muted">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨</td></tr>';
            document.getElementById('visibleCount').innerText = 0;
            return;
        }

        const rowsHtml = data.map(stock => {
            const colsHtml = g_columns.map(col => {
                let val = stock[col.key];
                if (val === undefined || val === null || val === '-' || val === '') {
                    return `<td><span class="text-muted">-</span></td>`;
                }

                let num = parseFloat(String(val).replace(/,/g, ''));
                let displayVal = val; 
                let isNegative = false;

                if (!isNaN(num)) {
                    isNegative = num < 0;
                    if (Math.abs(num) < 0.005) {
                        displayVal = "0.00";
                    } else {
                        displayVal = num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    if (col.suffix) {
                        displayVal += col.suffix;
                    }
                }

                if (isNegative) {
                    displayVal = `<span class="text-danger">${displayVal}</span>`;
                }
                
                return `<td>${displayVal}</td>`;
            }).join('');
            
            // âš ï¸ å…³é”®ä»£ç ï¼šç»™ä»£ç å’Œåç§°åˆ—ä¹ŸåŠ ä¸Š sticky-col ç±»ï¼Œå¹¶å¯¹åº”ä½ç½®ç±» col-code / col-name
            return `<tr class="clickable-row" onclick="loadChart('${stock.code}')">
                <td class="sticky-col col-code fw-bold ps-4 text-primary">${stock.code}</td>
                <td class="sticky-col col-name fw-bold">${stock.name}</td>
                <td class="text-muted small">${stock.date}</td>
                ${colsHtml}
            </tr>`;
        }).join('');
        
        tbody.innerHTML = rowsHtml;
        document.getElementById('visibleCount').innerText = data.length;
    }

    // --- ç­›é€‰ä¸æ’åºé€»è¾‘ (ä¿æŒä¸å˜) ---
    const activeFilters = {}; 

    function confirmFilter(btn, colKey) {
        const popup = btn.closest('.filter-popup');
        const minVal = popup.querySelector(`#min-${CSS.escape(colKey)}`).value;
        const maxVal = popup.querySelector(`#max-${CSS.escape(colKey)}`).value;

        if (!activeFilters[colKey]) activeFilters[colKey] = {};
        activeFilters[colKey].min = minVal === "" ? null : parseFloat(minVal);
        activeFilters[colKey].max = maxVal === "" ? null : parseFloat(maxVal);

        updateHeaderStyle(colKey);
        setTimeout(executeFiltering, 10);
    }

    function clearFilter(btn, colKey) {
        const popup = btn.closest('.filter-popup');
        popup.querySelector(`#min-${CSS.escape(colKey)}`).value = '';
        popup.querySelector(`#max-${CSS.escape(colKey)}`).value = '';
        
        if (activeFilters[colKey]) {
            activeFilters[colKey] = { min: null, max: null };
            updateHeaderStyle(colKey);
        }
        setTimeout(executeFiltering, 10);
    }

    function updateHeaderStyle(colKey) {
        const th = document.querySelector(`th[data-key="${colKey}"]`);
        const filter = activeFilters[colKey];
        if (filter && (filter.min !== null || filter.max !== null)) th.classList.add('filter-active');
        else th.classList.remove('filter-active');
    }

    function executeFiltering() {
        g_visibleStocks = g_stockData.filter(stock => {
            for (const [key, range] of Object.entries(activeFilters)) {
                if (range.min === null && range.max === null) continue;
                let rawVal = stock[key];
                if (!rawVal || rawVal === '-' || rawVal === '') return false;
                let val = parseFloat(String(rawVal).replace(/,/g, '').replace('%', ''));
                if (range.min !== null && val < range.min) return false;
                if (range.max !== null && val > range.max) return false;
            }
            return true;
        });
        if(sortState.key) {
             doSort(sortState.key, sortState.type);
        } else {
             renderTable(g_visibleStocks);
        }
    }

    let sortState = { key: '', dir: 'asc', type: '' };

    function sortTable(key, type) {
        document.querySelectorAll('.sort-icon').forEach(el => el.innerText = '');
        
        if (sortState.key === key) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        else { sortState.key = key; sortState.dir = 'asc'; }
        sortState.type = type; 
        
        const ths = document.querySelectorAll('thead th');
        ths.forEach(th => {
            const div = th.querySelector('.th-content');
            if(div && div.onclick && div.onclick.toString().includes(`'${key}'`)) {
                th.querySelector('.sort-icon').innerText = sortState.dir === 'asc' ? ' â–²' : ' â–¼';
            }
        });
        
        doSort(key, type);
        renderTable(g_visibleStocks);
    }

    function doSort(key, type) {
        g_visibleStocks.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];
            if (type === 'numeric') {
                valA = (valA === '-' || !valA) ? -Infinity : parseFloat(String(valA).replace(/,/g, ''));
                valB = (valB === '-' || !valB) ? -Infinity : parseFloat(String(valB).replace(/,/g, ''));
                return sortState.dir === 'asc' ? valA - valB : valB - valA;
            } else {
                valA = valA || ""; valB = valB || "";
                return sortState.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
        });
    }

    // --- API äº¤äº’ä¸å›¾è¡¨ ---
    function triggerRecalculate() {
        if(!confirm("ç¡®å®šè¡¥å…¨å—ï¼Ÿ")) return;
        document.getElementById('recalcBtn').disabled = true;
        fetch('/api/recalculate', { method: 'POST' });
    }
    function restartService() {
        if(!confirm("ç¡®å®šé‡å¯å—ï¼Ÿ")) return;
        fetch('/api/restart', { method: 'POST' }).then(() => {
            const mask = document.createElement('div');
            mask.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;";
            mask.innerHTML = `<div class="spinner-border text-primary mb-3" role="status"></div><h5 class="text-dark">æœåŠ¡æ­£åœ¨é‡å¯...</h5><p class="text-muted">3ç§’åè‡ªåŠ¨åˆ·æ–°</p>`;
            document.body.appendChild(mask);
            setTimeout(() => location.reload(), 3000);
        });
    }
    function triggerCrawl() {
        document.getElementById('refreshBtn').disabled = true;
        fetch('/api/trigger_crawl');
    }
    setInterval(() => {
        fetch('/api/status').then(res => res.json()).then(data => {
            const container = document.getElementById('progress-container');
            if (data.is_running) {
                container.style.display = 'block';
                const pct = data.total > 0 ? Math.round(data.current/data.total*100) : 0;
                document.getElementById('progress-bar').style.width = pct + "%";
                document.getElementById('progress-msg').innerText = `${data.message}`;
            } else if (container.style.display === 'block') {
                 location.reload();
            }
        });
    }, 1500);

    var myChart = echarts.init(document.getElementById('chart-container'));
    var chartModal = new bootstrap.Modal(document.getElementById('chartModal'));
    document.getElementById('chartModal').addEventListener('shown.bs.modal', () => myChart.resize());
    function loadChart(code) {
        chartModal.show(); myChart.showLoading();
        fetch(`/api/history/${code}`).then(res => res.json()).then(data => {
            myChart.hideLoading();
            myChart.setOption({
                tooltip: { trigger: 'axis' }, legend: { data: ['PE', 'PEG'] }, xAxis: { data: data.dates },
                yAxis: [ { type: 'value', name: 'PE' }, { type: 'value', name: 'PEG' } ],
                series: [ { name: 'PE', type: 'line', data: data.pe }, { name: 'PEG', type: 'line', yAxisIndex: 1, data: data.peg } ]
            });
        });
    }
</script>
</body>
</html>