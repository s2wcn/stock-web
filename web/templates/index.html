<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è´¢åŠ¡æ•°æ®ç³»ç»Ÿ - å¢å¼ºç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #e2e6ea !important; }
        #chart-container { height: 500px; width: 100%; }
        .table-container { height: calc(100vh - 150px); overflow: auto; font-size: 0.9rem; }
        thead th { position: sticky; top: 0; z-index: 10; background: #f8f9fa !important; white-space: nowrap; padding: 12px 10px; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #e9ecef !important; }
        .sortable-header::after { content: " â†•"; font-size: 0.7em; color: #aaa; margin-left: 5px; }
        .table-nowrap td { white-space: nowrap; vertical-align: middle; padding: 8px 15px; }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        #progress-container { width: 300px; display: none; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid py-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4">ğŸ“ˆ æ¸¯è‚¡å…¨ç»´è´¢åŠ¡æ•°æ®ç›‘æ§</h2>
        
        <div class="d-flex align-items-center">
            <div id="progress-container" class="me-3">
                <div class="d-flex justify-content-between small text-muted mb-1">
                    <span id="progress-msg">æ­£åœ¨æ›´æ–°...</span>
                    <span id="progress-pct">0%</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <span class="text-muted small me-3">ç‚¹å‡»è¡¨å¤´æ’åº / ç‚¹å‡»è¡Œçœ‹å›¾</span>
            
            <button id="refreshBtn" onclick="triggerCrawl()" class="btn btn-primary btn-sm">
                âš¡ æ‰‹åŠ¨åˆ·æ–°æ•°æ®
            </button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0 table-container">
            <table class="table table-bordered table-striped table-hover mb-0 table-nowrap" id="stockTable">
                <thead>
                    <tr>
                        <th class="bg-light text-primary">ä»£ç </th>
                        <th class="bg-light text-primary">åç§°</th>
                        <th>æ—¥æœŸ</th>
                        {% for field in fields %}
                        <th class="sortable-header" onclick="sortTable({{ loop.index0 + 3 }}, 'numeric')">
                            {{ field }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks %}
                    <tr class="clickable-row" onclick="loadChart('{{ stock.code }}')">
                        <td class="fw-bold">{{ stock.code }}</td>
                        <td>{{ stock.name }}</td>
                        <td>{{ stock.date }}</td>
                        {% for field in fields %}
                        <td>{{ stock[field] }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartTitle">å†å²è¶‹åŠ¿åˆ†æ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // === æ ¸å¿ƒé€»è¾‘ 1: è§¦å‘çˆ¬è™« ===
    function triggerCrawl() {
        const btn = document.getElementById('refreshBtn');
        btn.disabled = true;
        btn.innerText = "â³ æ­£åœ¨è¯·æ±‚...";

        fetch('/api/trigger_crawl')
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    // å¯åŠ¨æˆåŠŸï¼ŒUIçš„æ›´æ–°äº¤ç»™ pollingTask å¤„ç†
                    console.log("ä»»åŠ¡å·²å¯åŠ¨");
                } else {
                    alert(data.message);
                }
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                btn.innerText = "âš¡ æ‰‹åŠ¨åˆ·æ–°æ•°æ®";
            });
    }

    // === æ ¸å¿ƒé€»è¾‘ 2: è½®è¯¢è¿›åº¦ ===
    // æ¯ 1.5 ç§’æ£€æŸ¥ä¸€æ¬¡åå°çŠ¶æ€
    setInterval(pollStatus, 1500);

    function pollStatus() {
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                const btn = document.getElementById('refreshBtn');
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const progressMsg = document.getElementById('progress-msg');
                const progressPct = document.getElementById('progress-pct');

                if (data.is_running) {
                    // === è¿è¡Œä¸­ ===
                    btn.disabled = true;
                    btn.innerText = "ğŸš€ åå°æ›´æ–°ä¸­...";
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');

                    // æ˜¾ç¤ºè¿›åº¦æ¡
                    progressContainer.style.display = 'block';
                    
                    // è®¡ç®—ç™¾åˆ†æ¯”
                    let pct = 0;
                    if (data.total > 0) {
                        pct = Math.round((data.current / data.total) * 100);
                    }
                    
                    progressBar.style.width = pct + "%";
                    progressPct.innerText = pct + "%";
                    progressMsg.innerText = `${data.message} (${data.current}/${data.total})`;

                } else {
                    // === ç©ºé—²ä¸­ ===
                    // åªæœ‰å½“æŒ‰é’®è¿˜æ˜¯ç¦ç”¨çŠ¶æ€ï¼ˆè¯´æ˜åˆšæ‰åœ¨è·‘ï¼‰æ—¶ï¼Œæ‰æ¢å¤ï¼Œé¿å…é—ªçƒ
                    if (btn.disabled) {
                        btn.disabled = false;
                        btn.innerText = "âš¡ æ‰‹åŠ¨åˆ·æ–°æ•°æ®";
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-primary');
                        
                        // éšè—è¿›åº¦æ¡å‰ï¼Œå…ˆæ˜¾ç¤ºæ»¡æ ¼ä¸€ä¸‹
                        progressBar.style.width = "100%";
                        progressPct.innerText = "100%";
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            // ä»»åŠ¡å®Œæˆåï¼Œè‡ªåŠ¨åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®
                            alert("æ›´æ–°å®Œæˆï¼å³å°†åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°æ•°æ®ã€‚");
                            location.reload(); 
                        }, 1000);
                    }
                }
            });
    }

    // === ä¸‹é¢æ˜¯ä¹‹å‰çš„å›¾è¡¨å’Œæ’åºé€»è¾‘ (ä¿æŒä¸å˜) ===
    var myChart = echarts.init(document.getElementById('chart-container'));
    var chartModal = new bootstrap.Modal(document.getElementById('chartModal'));
    
    document.getElementById('chartModal').addEventListener('shown.bs.modal', function () {
        myChart.resize();
    });

    function loadChart(code) {
        chartModal.show();
        myChart.showLoading();
        fetch(`/api/history/${code}`)
            .then(response => response.json())
            .then(data => {
                myChart.hideLoading();
                document.getElementById('chartTitle').innerText = `${data.name} (${code}) - è´¢åŠ¡å†å²è¶‹åŠ¿`;
                var option = {
                    tooltip: { trigger: 'axis' },
                    grid: { left: '5%', right: '5%', bottom: '10%', containLabel: true },
                    legend: { data: ['PE (å¸‚ç›ˆç‡)', 'PEG'] },
                    xAxis: { type: 'category', data: data.dates },
                    yAxis: [ { type: 'value', name: 'PE' }, { type: 'value', name: 'PEG', alignTicks: true } ],
                    series: [
                        { name: 'PE (å¸‚ç›ˆç‡)', type: 'line', data: data.pe, smooth: true },
                        { name: 'PEG', type: 'line', yAxisIndex: 1, data: data.peg, smooth: true, itemStyle: { color: '#ff6b6b' } }
                    ]
                };
                myChart.setOption(option);
            })
            .catch(err => { myChart.hideLoading(); });
    }

    window.onresize = function() { myChart.resize(); };

    let sortDirection = {};
    function sortTable(columnIndex, type) {
        const table = document.getElementById("stockTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const currentDir = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
        sortDirection[columnIndex] = currentDir;

        rows.sort((rowA, rowB) => {
            const cellA = rowA.cells[columnIndex].innerText.trim();
            const cellB = rowB.cells[columnIndex].innerText.trim();
            if (type === 'numeric') {
                let valA = cellA === '-' ? -99999999 : parseFloat(cellA.replace(/,/g, ''));
                let valB = cellB === '-' ? -99999999 : parseFloat(cellB.replace(/,/g, ''));
                return currentDir === 'asc' ? valA - valB : valB - valA;
            } else {
                return currentDir === 'asc' ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            }
        });
        rows.forEach(row => tbody.appendChild(row));
    }
</script>
</body>
</html>