<!DOCTYPE html>
<html lang="zh" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è´¢åŠ¡æ•°æ®ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        /* === 1. å¸ƒå±€åŸºç¡€ === */
        html, body { 
            height: 100%; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f7fa !important; /* å…¨å±€èƒŒæ™¯å¾®è°ƒä¸ºæ·¡ç°è“ */
        }
        .main-wrapper { height: 100%; display: flex; flex-direction: column; }
        
        /* === 2. é¡¶éƒ¨å·¥å…·æ  === */
        .toolbar-section {
            flex-shrink: 0; 
            padding: 12px 24px; 
            background-color: #ffffff;
            border-bottom: 1px solid #e1e4e8; 
            z-index: 2000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); /* å¢åŠ ä¸€ç‚¹ç‚¹æ‚¬æµ®æ„Ÿ */
        }

        /* === 3. è¡¨æ ¼å®¹å™¨ === */
        .table-container {
            flex-grow: 1; 
            overflow: auto; 
            padding: 0; 
            position: relative;
            background: #fff;
        }
        .table { margin-bottom: 0; }

        /* === 4. è¡¨å¤´ç¾åŒ– (æ ¸å¿ƒä¿®æ”¹) === */
        thead th { 
            position: sticky; 
            top: 0; 
            z-index: 1000;
            /* èƒŒæ™¯æ”¹ä¸ºææ·¡çš„ç°è‰²ï¼ŒåŒºåˆ†å†…å®¹ */
            background-color: #f8f9fa !important; 
            /* åº•éƒ¨åŠ ç²—è¾¹æ¡† */
            border-bottom: 2px solid #e9ecef !important;
            border-top: none !important;
            border-left: none !important;
            border-right: none !important; /* å»é™¤å·¦å³è¾¹æ¡†ï¼Œæ›´æ¸…çˆ½ */
            padding: 0; 
            height: 48px; /* ç¨å¾®é™ä½é«˜åº¦ */
            vertical-align: middle;
            background-clip: padding-box;
            box-shadow: 0 1px 0 #e9ecef; /* æ»šåŠ¨æ—¶çš„é˜´å½±çº¿ */
        }
        
        /* è¡¨å¤´å†…å®¹åŒºåŸŸ */
        .th-content {
            padding: 0 16px; /* å¢åŠ å·¦å³é—´è· */
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            width: 100%; 
            height: 100%; 
            cursor: pointer; 
            position: relative;
            color: #495057; /* å­—ä½“æ·±ç°ï¼Œä¸è¦çº¯é»‘ */
            font-weight: 600; /* åŠç²—ä½“ */
            font-size: 13px;  /* å­—ä½“ç¨å¾®æ”¹å°ï¼Œæ˜¾å¾—ç²¾è‡´ */
            transition: background-color 0.2s;
        }
        
        /* é¼ æ ‡æ‚¬åœè¡¨å¤´æ•ˆæœ */
        .th-content:hover { 
            background-color: #eef1f6; 
            color: #0d6efd; /* æ‚¬åœå˜è“ */
        }

        /* === 5. å›¾æ ‡ç¾åŒ– === */
        /* æ’åºå›¾æ ‡ï¼šé»˜è®¤åŠé€æ˜ï¼Œæ‚¬åœå˜å® */
        .sort-icon { 
            font-size: 10px; 
            color: #adb5bd; 
            margin-left: 6px; 
            opacity: 0.5;
            transition: all 0.2s;
        }
        .th-content:hover .sort-icon { opacity: 1; color: #0d6efd; }
        
        /* é—®å·å›¾æ ‡ï¼šæ›´åŠ ä½è°ƒ */
        .info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 14px; height: 14px; 
            border-radius: 50%; 
            background-color: rgba(173, 181, 189, 0.3); /* åŠé€æ˜ç° */
            color: #6c757d; 
            font-size: 10px; 
            margin-left: 5px; 
            cursor: help;
            transition: all 0.2s;
        }
        .info-icon:hover { 
            background-color: #0d6efd; 
            color: white; 
        }

        /* === 6. ç­›é€‰çŠ¶æ€é«˜äº® === */
        /* å½“åˆ—è¢«ç­›é€‰æ—¶ï¼Œæ•´ä¸ªè¡¨å¤´å˜è“åº• */
        .filter-active .th-content { 
            background-color: #e8f2ff; 
            color: #0d6efd;
            border-bottom: 2px solid #0d6efd; /* åº•éƒ¨åŠ æ·±è“çº¿ */
        }
        .filter-active .sort-icon { color: #0d6efd; opacity: 1; }

        /* === 7. é«˜çº§ç­›é€‰æµ®çª— === */
        .filter-popup {
            display: none; 
            position: absolute; top: 100%; left: 0;
            min-width: 220px;
            background: white;
            border: 1px solid rgba(0,0,0,0.1); /* è¾¹æ¡†æ›´æ·¡ */
            box-shadow: 0 8px 24px rgba(0,0,0,0.12); /* æŠ•å½±æ›´æŸ”å’Œ */
            border-radius: 6px;
            padding: 16px;
            z-index: 1050;
            cursor: default; 
            font-size: 13px;
        }
        thead th:hover .filter-popup, 
        .filter-popup:hover { display: block; }
        thead th:last-child .filter-popup { left: auto; right: 0; }

        /* è¾“å…¥æ¡†ç¾åŒ– */
        .filter-input-group { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .filter-input { 
            width: 80px; font-size: 13px; padding: 6px; 
            border-color: #dee2e6; background: #f8f9fa;
        }
        .filter-input:focus { background: #fff; border-color: #86b7fe; box-shadow: none; }
        .filter-label { font-size: 12px; color: #868e96; margin-bottom: 6px; display: block; font-weight: 500;}

        /* === 8. æ•°æ®è¡Œç¾åŒ– === */
        .table-nowrap td { 
            white-space: nowrap; 
            vertical-align: middle; 
            padding: 10px 16px; /* å¢åŠ èˆ’é€‚åº¦ */
            font-size: 13px;    /* å­—ä½“ç»Ÿä¸€ */
            color: #212529;
            border-bottom: 1px solid #f1f3f5; /* ææ·¡çš„åˆ†å‰²çº¿ */
        }
        .clickable-row { cursor: pointer; transition: background-color 0.1s; }
        .clickable-row:hover { background-color: #f1f8ff !important; } /* æ‚¬åœè‰²æ›´æ¸…çˆ½ */
        
        /* ç¬¬ä¸€åˆ—ä»£ç åŠ ç²— */
        .fw-bold { font-weight: 600 !important; color: #343a40; }
        
        /* === å…¶ä»– === */
        #chart-container { height: 500px; width: 100%; }
        .tooltip { z-index: 10000 !important; }
    </style>
</head>
<body class="bg-light">

<div class="main-wrapper">
    <div class="toolbar-section">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h2 class="h6 mb-0 fw-bold text-dark d-flex align-items-center">
                    <span style="font-size: 1.2rem; margin-right: 8px;">ğŸ“Š</span> æ¸¯è‚¡å…¨ç»´è´¢åŠ¡ç›‘æ§
                </h2>
                <span class="badge bg-light text-secondary border ms-3 fw-normal">
                    å…± <strong id="visibleCount" class="text-dark">{{ stocks|length }}</strong> / {{ stocks|length }}
                </span>
                <span class="badge bg-light text-secondary border ms-2 fw-normal">
                    ğŸ•’ <span id="updateTime">{{ last_updated }}</span>
                </span>
            </div>
            
            <div class="d-flex align-items-center">
                <div id="progress-container" class="me-3" style="display:none;">
                    <div class="progress" style="height: 6px; width: 120px;">
                        <div id="progress-bar" class="progress-bar bg-success" style="width: 0%"></div>
                    </div>
                    <div class="text-center" style="font-size: 10px; color: #999; margin-top: 2px;" id="progress-msg"></div>
                </div>
                
                <div class="btn-group">
                    <button id="refreshBtn" onclick="triggerCrawl()" class="btn btn-outline-secondary btn-sm">âš¡ åˆ·æ–°</button>
                    <button id="recalcBtn" onclick="triggerRecalculate()" class="btn btn-outline-secondary btn-sm">ğŸ› ï¸ è¡¥å…¨</button>
                    <button id="restartBtn" onclick="restartService()" class="btn btn-outline-danger btn-sm">ğŸ”¥ é‡å¯</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-hover mb-0 table-nowrap" id="stockTable">
            <thead>
                <tr>
                    <th style="min-width: 90px;"><div class="th-content" onclick="sortTable('code', 'string')">ä»£ç  <span class="sort-icon"></span></div></th>
                    <th style="min-width: 120px;"><div class="th-content" onclick="sortTable('name', 'string')">åç§° <span class="sort-icon"></span></div></th>
                    <th style="min-width: 100px;"><div class="th-content" onclick="sortTable('date', 'string')">æ—¥æœŸ <span class="sort-icon"></span></div></th>

                    {% for col in columns %}
                    <th data-key="{{ col.key }}">
                        <div class="th-content" onclick="sortTable('{{ col.key }}', 'numeric')">
                            <span class="d-flex align-items-center">
                                {{ col.label }}
                                {% if col.tip %}
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="<b>{{ col.desc }}</b><br><small>{{ col.tip }}</small>"
                                      onclick="event.stopPropagation()">?</span>
                                {% endif %}
                            </span>
                            <span class="sort-icon"></span>
                        </div>

                        <div class="filter-popup" onclick="event.stopPropagation()">
                            <span class="filter-label">ç­›é€‰ {{ col.label }}:</span>
                            <div class="filter-input-group">
                                <input type="number" class="form-control form-control-sm filter-input" placeholder="Min" id="min-{{ col.key }}">
                                <span class="text-muted">-</span>
                                <input type="number" class="form-control form-control-sm filter-input" placeholder="Max" id="max-{{ col.key }}">
                            </div>
                            <div class="d-flex justify-content-between pt-2 border-top">
                                <button class="btn btn-light btn-sm px-3" style="font-size: 12px;" onclick="clearFilter(this, '{{ col.key }}')">æ¸…é™¤</button>
                                <button class="btn btn-primary btn-sm px-3" style="font-size: 12px;" onclick="confirmFilter(this, '{{ col.key }}')">ç¡®è®¤</button>
                            </div>
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartTitle">å†å²è¶‹åŠ¿åˆ†æ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"><div id="chart-container"></div></div>
        </div>
    </div>
</div>

<script>
    const g_stockData = {{ stocks | tojson | safe }};
    const g_columns = {{ columns | tojson | safe }};
    let g_visibleStocks = [...g_stockData]; 
    
    document.addEventListener("DOMContentLoaded", function(){
        renderTable(g_stockData);
        [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function (el) { return new bootstrap.Tooltip(el, {html: true}); });
    });

    // æ¸²æŸ“å‡½æ•° (åŒ…å« -0.00 ä¿®å¤)
    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100" class="text-center py-4 text-muted">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨</td></tr>';
            document.getElementById('visibleCount').innerText = 0;
            return;
        }

        const rowsHtml = data.map(stock => {
            const colsHtml = g_columns.map(col => {
                let val = stock[col.key];
                if (val !== undefined && val !== null && val !== '-' && val !== '') {
                    let num = parseFloat(String(val).replace(/,/g, ''));
                    if (Math.abs(num) < 0.005) {
                        val = "0.00";
                    } else {
                        val = num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    // ç»™è´Ÿæ•°åŠ ä¸ªé¢œè‰² (å¯é€‰)
                    if (num < 0) val = `<span class="text-danger">${val}</span>`;
                } else {
                    val = `<span class="text-muted">-</span>`;
                }
                return `<td>${val}</td>`;
            }).join('');
            
            return `<tr class="clickable-row" onclick="loadChart('${stock.code}')">
                <td class="fw-bold ps-4 text-primary">${stock.code}</td>
                <td class="fw-bold">${stock.name}</td>
                <td class="text-muted small">${stock.date}</td>
                ${colsHtml}
            </tr>`;
        }).join('');
        
        tbody.innerHTML = rowsHtml;
        document.getElementById('visibleCount').innerText = data.length;
    }

    // ç­›é€‰é€»è¾‘
    const activeFilters = {}; 

    function confirmFilter(btn, colKey) {
        const popup = btn.closest('.filter-popup');
        const minVal = popup.querySelector(`#min-${CSS.escape(colKey)}`).value;
        const maxVal = popup.querySelector(`#max-${CSS.escape(colKey)}`).value;

        if (!activeFilters[colKey]) activeFilters[colKey] = {};
        activeFilters[colKey].min = minVal === "" ? null : parseFloat(minVal);
        activeFilters[colKey].max = maxVal === "" ? null : parseFloat(maxVal);

        updateHeaderStyle(colKey);
        setTimeout(executeFiltering, 10);
        // ç­›é€‰åè‡ªåŠ¨å…³é—­æµ®çª—ï¼ˆé€šè¿‡æ¨¡æ‹Ÿç‚¹å‡»bodyå…³é—­ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œå®é™…ä¸Šhover cssæ§åˆ¶æ˜¾ç¤ºï¼‰
        // CSS hoveræ§åˆ¶ä¸‹ï¼Œç§»å¼€é¼ æ ‡å³æ¶ˆå¤±ï¼Œä½“éªŒè¾ƒå¥½
    }

    function clearFilter(btn, colKey) {
        const popup = btn.closest('.filter-popup');
        popup.querySelector(`#min-${CSS.escape(colKey)}`).value = '';
        popup.querySelector(`#max-${CSS.escape(colKey)}`).value = '';
        
        if (activeFilters[colKey]) {
            activeFilters[colKey] = { min: null, max: null };
            updateHeaderStyle(colKey);
        }
        setTimeout(executeFiltering, 10);
    }

    function updateHeaderStyle(colKey) {
        const th = document.querySelector(`th[data-key="${colKey}"]`);
        const filter = activeFilters[colKey];
        if (filter && (filter.min !== null || filter.max !== null)) th.classList.add('filter-active');
        else th.classList.remove('filter-active');
    }

    function executeFiltering() {
        g_visibleStocks = g_stockData.filter(stock => {
            for (const [key, range] of Object.entries(activeFilters)) {
                if (range.min === null && range.max === null) continue;
                let rawVal = stock[key];
                if (!rawVal || rawVal === '-' || rawVal === '') return false;
                let val = parseFloat(String(rawVal).replace(/,/g, '').replace('%', ''));
                if (range.min !== null && val < range.min) return false;
                if (range.max !== null && val > range.max) return false;
            }
            return true;
        });
        // é‡æ–°åº”ç”¨å½“å‰çš„æ’åºï¼ˆå¦‚æœä¹‹å‰æœ‰æ’åºçš„è¯ï¼‰
        if(sortState.key) {
             doSort(sortState.key, sortState.type);
        } else {
             renderTable(g_visibleStocks);
        }
    }

    // æ’åºé€»è¾‘
    let sortState = { key: '', dir: 'asc', type: '' };

    function sortTable(key, type) {
        document.querySelectorAll('.sort-icon').forEach(el => el.innerText = '');
        
        if (sortState.key === key) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        else { sortState.key = key; sortState.dir = 'asc'; }
        sortState.type = type; // è®°å½•ç±»å‹æ–¹ä¾¿ç­›é€‰åé‡æ’
        
        const ths = document.querySelectorAll('thead th');
        ths.forEach(th => {
            const div = th.querySelector('.th-content');
            if(div && div.onclick && div.onclick.toString().includes(`'${key}'`)) {
                th.querySelector('.sort-icon').innerText = sortState.dir === 'asc' ? ' â–²' : ' â–¼';
            }
        });
        
        doSort(key, type);
        renderTable(g_visibleStocks);
    }

    function doSort(key, type) {
        g_visibleStocks.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];
            if (type === 'numeric') {
                valA = (valA === '-' || !valA) ? -Infinity : parseFloat(String(valA).replace(/,/g, ''));
                valB = (valB === '-' || !valB) ? -Infinity : parseFloat(String(valB).replace(/,/g, ''));
                return sortState.dir === 'asc' ? valA - valB : valB - valA;
            } else {
                valA = valA || ""; valB = valB || "";
                return sortState.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
        });
    }

    // API äº¤äº’
    function triggerRecalculate() {
        if(!confirm("ç¡®å®šè¡¥å…¨å—ï¼Ÿ")) return;
        document.getElementById('recalcBtn').disabled = true;
        fetch('/api/recalculate', { method: 'POST' });
    }
    function restartService() {
        if(!confirm("ç¡®å®šé‡å¯å—ï¼Ÿ")) return;
        fetch('/api/restart', { method: 'POST' }).then(() => {
            const mask = document.createElement('div');
            mask.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;";
            mask.innerHTML = `<div class="spinner-border text-primary mb-3" role="status"></div><h5 class="text-dark">æœåŠ¡æ­£åœ¨é‡å¯...</h5><p class="text-muted">3ç§’åè‡ªåŠ¨åˆ·æ–°</p>`;
            document.body.appendChild(mask);
            setTimeout(() => location.reload(), 3000);
        });
    }
    function triggerCrawl() {
        document.getElementById('refreshBtn').disabled = true;
        fetch('/api/trigger_crawl');
    }
    setInterval(() => {
        fetch('/api/status').then(res => res.json()).then(data => {
            const container = document.getElementById('progress-container');
            if (data.is_running) {
                container.style.display = 'block';
                const pct = data.total > 0 ? Math.round(data.current/data.total*100) : 0;
                document.getElementById('progress-bar').style.width = pct + "%";
                document.getElementById('progress-msg').innerText = `${data.message}`;
            } else if (container.style.display === 'block') {
                 location.reload();
            }
        });
    }, 1500);

    // å›¾è¡¨
    var myChart = echarts.init(document.getElementById('chart-container'));
    var chartModal = new bootstrap.Modal(document.getElementById('chartModal'));
    document.getElementById('chartModal').addEventListener('shown.bs.modal', () => myChart.resize());
    function loadChart(code) {
        chartModal.show(); myChart.showLoading();
        fetch(`/api/history/${code}`).then(res => res.json()).then(data => {
            myChart.hideLoading();
            myChart.setOption({
                tooltip: { trigger: 'axis' }, legend: { data: ['PE', 'PEG'] }, xAxis: { data: data.dates },
                yAxis: [ { type: 'value', name: 'PE' }, { type: 'value', name: 'PEG' } ],
                series: [ { name: 'PE', type: 'line', data: data.pe }, { name: 'PEG', type: 'line', yAxisIndex: 1, data: data.peg } ]
            });
        });
    }
</script>
</body>
</html>